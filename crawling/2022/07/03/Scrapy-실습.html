<h1 id="scrapy-실습">Scrapy 실습</h1>

<p>http꞉// 를 붙여주면, start_urls 에서 http꞉// 를 무조건 붙여주기 때문에, 결과적으로 http꞉// 가 두 번 붙게되어, 강제로 http꞉// 를 start_urls 에서 삭제해야 한다</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// 프로젝트를 생성하고 크롤러 모듈을 생성하자

scrapy startproject ecommerce1

scrapy genspider gmarket_best corners.gmarket.co.kr/Bestsellers
</code></pre></div></div>
<p>위의 명령어를 통해 url에 맞는 크롤러 python 모듈을 생성하자</p>

<p>start_urls는 def parse의 response로 들어가게 된다</p>

<ul>
  <li>구조를 한번 살펴보고 내려가자</li>
  <li>** ** 표시를 한 것이 오늘의 핵심 파일이 될 예정이다.</li>
</ul>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
scrapy.cfg <span class="c"># deploy configuration file</span>
    ecommerce1/ <span class="c"># project's Python module, you'll import your code from her</span>
        __init__.py
        <span class="k">**</span>items.py<span class="k">**</span> <span class="c"># project items definition file</span>
        pipelines.py <span class="c"># project pipelines file</span>
        settings.py <span class="c"># project settings file</span>
        spiders/ <span class="c"># a directory where you'll later put your spiders</span>
            __init__.py
            <span class="k">**</span>gmarket.py<span class="k">**</span>

</code></pre></div></div>

<p>spiders/gmarket_best.py <br />
<code class="language-plaintext highlighter-rouge">def parse</code> 부분을 아래와 같이 변경</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">scrapy</span>


<span class="k">class</span> <span class="nc">GmarketBestSpider</span><span class="p">(</span><span class="n">scrapy</span><span class="p">.</span><span class="n">Spider</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s">'gmarket_best'</span>
    <span class="n">allowed_domains</span> <span class="o">=</span> <span class="p">[</span><span class="s">'corners.gmarket.co.kr'</span><span class="p">]</span>
    <span class="n">start_urls</span> <span class="o">=</span> <span class="p">[</span><span class="s">'http://corners.gmarket.co.kr/'</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
        <span class="n">titles</span> <span class="o">=</span> <span class="n">response</span><span class="p">.</span><span class="n">css</span><span class="p">(</span><span class="s">'div.best-list li &gt; a::text'</span><span class="p">).</span><span class="n">getall</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">title</span> <span class="ow">in</span> <span class="n">titles</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
</code></pre></div></div>

<p>!scrapy crawl gmarket_best 을 통해 크롤링 수행할 수 있다</p>

<h3 id="itemspy">items.py</h3>

<blockquote>
  <p>크롤링 데이터 다루기꞉ 저장하기
items.py 파일 확인해보자 &gt; items.py # project items definition file</p>
</blockquote>

<p>어떤 아이템들을 가져올건지 items.py에 선언을 해줘야 한다</p>

<p>선언이 된 아이템들을 gmarket_best.py에서 가져와 전달을 해준다.
위의 과정을 거쳐야 scrapy에서 저장을 하는 등의 작업을 수행할 수 있게 된다</p>

<ul>
  <li>items.py</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Define here the models for your scraped items
#
# See documentation in:
# https://docs.scrapy.org/en/latest/topics/items.html
</span>
<span class="kn">import</span> <span class="nn">scrapy</span>


<span class="k">class</span> <span class="nc">Ecommerce1Item</span><span class="p">(</span><span class="n">scrapy</span><span class="p">.</span><span class="n">Item</span><span class="p">):</span>
    <span class="c1"># define the fields for your item here like:
</span>    <span class="c1"># name = scrapy.Field()
</span>    <span class="c1"># 저장할 데이터 이름 = scrapy.Field() 과 같이 작성
</span>    <span class="n">title</span> <span class="o">=</span> <span class="n">scrapy</span><span class="p">.</span><span class="n">Field</span><span class="p">()</span>
</code></pre></div></div>

<p>items.py에 전달하기 위해서는 <code class="language-plaintext highlighter-rouge">gmarket_best.py</code>를 아래와 같이 수정해야 한다</p>

<h4 id="gmarket_bestpy-수정">gmarket_best.py 수정</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="kn">import</span> <span class="nn">scrapy</span>

<span class="c1">### items.py 의 클래스명인 Ecommerce1Item 을 import 하기
</span>
<span class="kn">from</span> <span class="nn">ecommerce1.items</span> <span class="kn">import</span> <span class="n">Ecommerce1Item</span>

<span class="k">class</span> <span class="nc">GmarketSpider</span><span class="p">(</span><span class="n">scrapy</span><span class="p">.</span><span class="n">Spider</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s">'gmarket_best'</span>
    <span class="n">allowed_domains</span> <span class="o">=</span> <span class="p">[</span><span class="s">'corners.gmarket.co.kr/Bestsellers'</span><span class="p">]</span>
    <span class="n">start_urls</span> <span class="o">=</span> <span class="p">[</span><span class="s">'http://corners.gmarket.co.kr/Bestsellers/'</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
        <span class="n">titles</span> <span class="o">=</span> <span class="n">response</span><span class="p">.</span><span class="n">css</span><span class="p">(</span><span class="s">'div.best-list li &gt; a::text'</span><span class="p">).</span><span class="n">getall</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">title</span> <span class="ow">in</span> <span class="n">titles</span><span class="p">:</span>
            <span class="n">item</span> <span class="o">=</span> <span class="n">Ecommerce1Item</span><span class="p">()</span> <span class="c1">#선언을 통해 item 객체 생성
</span>            <span class="c1"># items.py 에서 정의한 scrapy.Field() 명을 동일하게 써줘야 함
</span>            <span class="n">item</span><span class="p">[</span><span class="s">'title'</span><span class="p">]</span> <span class="o">=</span> <span class="n">title</span> <span class="c1"># parsing해서 가져온 데이터를 field 열에 계속 넣어준다.
</span>            <span class="k">yield</span> <span class="n">item</span> <span class="c1"># yield 하는 순간 데이터가 items.py로 쌓인다
</span>
</code></pre></div></div>
<ul>
  <li>items.py 필드명 선언 -&gt;</li>
  <li>crawling python file에서 items.py import를 통해 불러와 item 객체 생성 -&gt;</li>
  <li>미리 생성해놓은 필드에 parsing해온 데이터를 yield를 통해 적재하기</li>
</ul>

<h4 id="다양한-데이터-format으로-아이템들을-저장할-수-있다">다양한 데이터 format으로 아이템들을 저장할 수 있다.</h4>

<ul>
  <li>csv, xml, json 포멧</li>
  <li>터미널 환경에서, 크롤링을 실행 시켰던 ecommerce1/ecommerce1 폴더에서 다음 명령을 수행하자</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// scrapy crawl 크롤러명 -o 저장할 파일명 -t 저장포멧

// 예
scrapy crawl gmarket_best -o gmarket_best.csv -t csv
scrapy crawl gmarket_best -o gmarket_best.xml -t xml

scrapy crawl gmarket_best -o gmarket_best.json -t json
&gt; json 파일을 확인하면, 한글문자가 깨져나온다 &gt; settings.py를 수정해줘야 한다
</code></pre></div></div>

<p><strong>settings.py</strong>에 들어가서 아래의 코드를 추가해주어야 한다</p>

<p>해당 파일 안에 utf-8 encoding 설정을 추가해준다 (위치는 상관 없다)</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># FEED_EXPORT_ENCODING 추가</span>
FEED_EXPORT_ENCODING <span class="o">=</span> <span class="s1">'utf-8'</span>
</code></pre></div></div>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="o">!</span> scrapy crawl gmarket_best <span class="nt">-o</span> gmarket_best.csv <span class="nt">-t</span> csv

// 아래와 같이 gmarket_best.csv 파일이 생성된 것을 확인 할 수 있다.
<span class="o">!</span> <span class="nb">ls
</span>__init__.py      <span class="k">**</span>gmarket_best.csv<span class="k">**</span> middlewares.py   settings.py
__pycache__      items.py         pipelines.py     spiders
</code></pre></div></div>

